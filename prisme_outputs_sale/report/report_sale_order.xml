<?xml version="1.0" encoding="utf-8"?>
<!-- 
###########################################################################
#
#    Prisme Solutions Informatique SA
#    Copyright (c) 2016 Prisme Solutions Informatique SA <http://prisme.ch>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as
#    published by the Free Software Foundation, either version 3 of the
#    License, or (at your option) any later version.
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#    You should have received a copy of the GNU Affero General Public Lic
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Project ID:    OERP-003-02    T502
#
##########################################################################
 -->
<odoo>
	<data>



		<template id="report_so_view">
			<t t-call="web.external_layout">
				<t t-set="o" t-value="doc.with_context(lang=lang)" />
				<div class="page">
					<div class="oe_structure" />
					<t t-set="is_order" t-value="o.state=='draft' or o.state=='sent'" />

					<table class="w-100" style="margin-top:32px">
						<tr>

							<th style="width: 60%;">
								<strong class="mr16">Shipping address :</strong>
								<span class="text-nowrap">
									<address t-field="o.partner_shipping_id" class="small"
										t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}' />
								</span>
								<strong class="mr16">Invoice address :</strong>
								<span class="text-nowrap">
									<address t-field="o.partner_invoice_id" class="small"
										t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}' />
								</span>


							</th>
							<th style="width: 40%;">
								<span class="text-nowrap">
									<address t-field="o.partner_id" class="small"
										t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}' />
								</span>
							</th>
						</tr>
					</table>
					<span t-field="o.header_comment" />
					<h2 class="o_bold" style="margin-top:16px">
						<t t-if="is_order">Order N°</t>
						<t t-else="">Quotation N°</t>
						<span t-field="o.name" />
					</h2>
					<div id="informations" class="mt-3 mb-3">
						<t t-if="is_order">
							<table class="table table-bordered table-sm text-center"
								style="margin-bottom: 2em;">
								<tr class="align-middle small font-weight-bold">
									<th>
										<strong class="mr16">
											<font style="font-size: 12px;">Your Reference</font>
										</strong>
									</th>
									<th>
										<strong class="mr16">
											<font style="font-size: 12px;">Date Ordered</font>
										</strong>
									</th>

									<th>
										<strong class="mr16">
											<font style="font-size: 12px;">Our Reference</font>
										</strong>
									</th>
									<th>
										<strong class="mr16">
											<font style="font-size: 12px;">Payment Term</font>
										</strong>
									</th>
								</tr>
								<tr>
									<td>
										<span class="text-nowrap small"
											t-field="o.client_order_ref" />
									</td>


									<td>
										<span class="text-nowrap small" t-field="o.date_order" />
									</td>

									<td>
										<span class="text-nowrap small" t-field="o.user_id" />
									</td>
									<td>
										<span class="text-nowrap small"
											t-field="o.payment_term_id" />
									</td>
								</tr>
							</table>
						</t>
						<t t-else="">
							<table class="table table-bordered table-sm text-center"
								style="margin-bottom: 2em;">
								<tr class="align-middle small font-weight-bold">
									<th class="align-middle small font-weight-bold">
										<strong class="mr16">
											<font style="font-size: 12px;">Your Reference</font>
										</strong>
									</th>
									<th>
										<strong class="mr16">
											<font style="font-size: 12px;">Quotation Date</font>
										</strong>
									</th>
									<th>
										<strong class="mr16">
											<font style="font-size: 12px;">Quotation Validity</font>
										</strong>
									</th>
								</tr>
								<tr>
									<td>
										<span class="text-nowrap small"
											t-field="o.client_order_ref" />
									</td>
									<td>
										<span class="text-nowrap small" t-field="o.date_order" />
									</td>

									<td>
										<span class="text-nowrap small" t-field="o.validity_date" />
									</td>
								</tr>
								<tr class="align-middle small font-weight-bold">
									<th>
										<strong class="mr16">
											<font style="font-size: 12px;">Our Reference</font>
										</strong>
									</th>
									<th>
										<strong class="mr16">
											<font style="font-size: 12px;">Payment Term</font>
										</strong>
									</th>
									<th>
										<strong class="mr16">
											<font style="font-size: 12px;">Quotation Comment</font>
										</strong>
									</th>
								</tr>
								<tr>
									<td>
										<span class="text-nowrap small" t-field="o.user_id" />
									</td>
									<td>
										<span class="text-nowrap small"
											t-field="o.payment_term_id" />
									</td>
									<td>
										<span class="text-nowrap small"
											t-field="o.quotation_comment" />
									</td>
								</tr>
							</table>
						</t>
					</div>
					<br />



					<table class="w-100 table-sm">
						<thead class="border-bottom border-dark">
							<tr>
								<th name="th_description" class="text-left" style="width: 190;">
									<span>Description</span>
								</th>
								<th name="th_vat"
									t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
									<span>VAT</span>
								</th>
								<th name="th_quantity" class="text-right">
									<span>Quantity</span>
								</th>
								<th name="th_priceunit"
									t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
									<span>Unit Price</span>
								</th>
								<th name="th_price_unit" t-if="display_discount"
									t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
									<span>Disc.</span>
								</th>
								<th name="th_subtotal" class="text-right">
									<!--<t groups="account.group_show_line_subtotals_tax_excluded">Amount</t> 
										<t groups="account.group_show_line_subtotals_tax_included">Total Price</t> -->
									<span>
										Price
										<span t-field="o.pricelist_id.currency_id.symbol" />
									</span>
								</th>
							</tr>
						</thead>
						</table>
						
						<t t-set="current_subtotal" t-value="0" />
							<t t-foreach="o.order_line" t-as="line">
								<t t-set="current_subtotal"
									t-value="current_subtotal + line.price_subtotal"
									groups="account.group_show_line_subtotals_tax_excluded" />
								<t t-set="current_subtotal"
									t-value="current_subtotal + line.price_total"
									groups="account.group_show_line_subtotals_tax_included" />
						
						<table class="w-100 table-sm">
						<tbody>				


								<tr class="border-bottom">
									<t
										t-if="not line.display_type and line.layout_type=='article'"
										name="account_invoice_line_accountable">

										<td name="account_invoice_line_name" style="width: 190;">
											<span t-field="line.name" t-options="{'widget': 'text'}" />
										</td>
										<td name="td_taxes" class="text-right">
											<span
												t-esc="', '.join(map(lambda x: (x.description or x.name), line.tax_id))" />
										</td>
										<td class="text-right">
											<span t-field="line.product_uom_qty" />
											<span t-field="line.product_uom_id"
												groups="uom.group_uom" />
										</td>
										<td
											t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
											<span class="text-nowrap" t-field="line.price_unit" />
										</td>
										<td t-if="display_discount"
											t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
											<span class="text-nowrap"
												t-esc="o._get_line_discount(line)" />
										</td>
										<td class="text-right o_price_total">
											<span class="text-nowrap" t-field="line.price_subtotal"
												groups="account.group_show_line_subtotals_tax_excluded" />
											<span class="text-nowrap" t-field="line.price_total"
												groups="account.group_show_line_subtotals_tax_included" />
										</td>

									</t>

									<t t-if="line.display_type == 'line_section'">
										<td colspan="99">
											<span t-field="line.name" t-options="{'widget': 'text'}" />
										</td>
										<t t-set="current_section" t-value="line" />
										<t t-set="current_subtotal" t-value="0" />
									</t>
									<t t-if="line.display_type == 'line_note'">
										<td colspan="99">
											<span t-field="line.name" t-options="{'widget': 'text'}" />
										</td>
									</t>
								</tr>
								<t	t-if="current_section and (line_last or o.order_line[line_index+1].display_type == 'line_section') and o.company_id.totals_below_sections">
								<t t-set="show_subtotal" t-value="False" />
								<t t-set="foo" t-value="False"/>
								<t t-foreach="range(len(o.order_line)-line_index)" t-as="l">
								<t t-if="foo == False">
									<t	t-if="o.order_line[line_index+l_index].layout_type == 'article'">									
									 <t t-set="foo" t-value="True"/>
									</t>
									<t	t-if="o.order_line[line_index+l_index].display_type == 'line_section'">									
									 <t t-set="foo" t-value="True"/>
									 <t t-set="show_subtotal" t-value="True" />
									</t>
									
								</t>
								</t>
								</t>
								<t	t-if="(line_last and current_section and o.company_id.totals_below_sections) or show_subtotal">
									<tr class="is-subtotal">
										<td colspan="3">
											<strong class="mr16">Subtotal
											<span t-field="current_section.name" t-options="{'widget': 'text'}" /> 
											</strong>
											</td>
											<td colspan="99">
											<strong class="mr16">
											<span class="text-right" t-esc="current_subtotal"
												t-options='{"widget": "monetary", "display_currency": o.currency_id}' /></strong>
										</td>
									</tr>
								</t>

								
								<t t-if="line.layout_type=='line'">
									<tr><td class="border-bottom border-dark" colspan="99">
										<font color="white">
										</font>
									</td></tr>
								</t>
							
						</tbody>
					</table>
					<t t-if="line.layout_type=='break'">
								<tr>
									<td>
										<p style="page-break-after:always;"/>
										<br/>
									</td>
									</tr>
								</t>
					</t>

					<div class="clearfix">
						<div id="total" class="row">
							<div t-attf-class="col-4 ml-auto">
								<table class="table table-sm"
									style="page-break-inside: avoid;">

									<!-- Amount without taxes -->
									<tr class="border-black o_subtotal" style="">
										<td>Total w/out VAT</td>
										<td class="text-right">
											<span t-field="o.amount_untaxed" />
										</td>
									</tr>
									<tr>
										<td>Taxes</td>
										<td class="text-right">
											<span t-field="o.amount_tax" />
										</td>
									</tr>
									<tr class="border-black o_total">
										<td>
											<strong>Total with VAT</strong>
										</td>
										<td class="text-right">
											<span class="text-nowrap" t-field="o.amount_total" />
										</td>
									</tr>
								</table>
							</div>
						</div>
					</div>
					<p t-if="o.fiscal_position_id.note" name="note" class="mt-5">
						<span t-field="o.fiscal_position_id.note" />
					</p>
					<div class="oe_structure" />
				</div>
			</t>
		</template>

		<!-- Create the base report -->
		<template id="report_so_base">
			<t t-call="web.html_container">
				<t t-foreach="docs" t-as="doc">
					<t t-set="lang" t-value="doc.partner_id.lang" />
					<t t-call="prisme_outputs_sale.report_so_view" t-lang="lang" />
				</t>
			</t>
		</template>

		<report id="prisme_report_so" model="sale.order"
			string="Prisme Quotation/SO"
			name="prisme_outputs_sale.report_so_base"
			file="prisme_outputs_sale.report_so_base" report_type="qweb-pdf" />
	</data>
</odoo>