<?xml version="1.0" encoding="utf-8"?>
<!-- 
###########################################################################
#
#    Prisme Solutions Informatique SA
#    Copyright (c) 2016 Prisme Solutions Informatique SA <http://prisme.ch>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as
#    published by the Free Software Foundation, either version 3 of the
#    License, or (at your option) any later version.
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#    You should have received a copy of the GNU Affero General Public Lic
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Project ID:    OERP-003-02    T502
#
##########################################################################
 -->
<odoo>
	<data>



		<template id="report_so_view">
			<t t-call="web.external_layout">
				<t t-set="o" t-value="doc.with_context(lang=lang)" />
				<div class="page">
					<div class="oe_structure" />
					<t t-set="is_order" t-value="o.state!='draft' and o.state!='sent'" />

					<table class="w-100" style="margin-top:32px">
						<tr>

							<th style="width: 60%;">
								<strong style="width: 40%; font-family: 'DejaVu Sans'; font-size: 10.5pt; font-weight: bold; line-height: normal;">Shipping address :<br/></strong>
								<span style="width: 40%; font-family: 'DejaVu Sans'; font-size: 10.5pt; font-weight: normal;">
									<t t-if="o.partner_shipping_id.is_company">
										<div t-esc="o.partner_shipping_id.name"></div>
									</t>
									<t t-else="">
										<t t-if="o.partner_shipping_id.parent_id"><div t-esc="o.partner_shipping_id.parent_id.name"></div></t>
										<div><t t-if="o.partner_shipping_id.title"><t t-esc="o.partner_shipping_id.title.name"/>&#160;</t><t t-esc="o.partner_shipping_id.name"/><br/></div>
									</t>
									<span t-field="o.partner_shipping_id" t-options='{"widget": "contact", "fields": ["address"], "no_marker": True}'/>
									<br/>
								</span>
								<strong style="width: 40%; font-family: 'DejaVu Sans'; font-size: 10.5pt; font-weight: bold; line-height: normal;">Invoice address :<br/></strong>
								<span style="width: 40%; font-family: 'DejaVu Sans'; font-size: 10.5pt; font-weight: normal;">
									<t t-if="o.partner_invoice_id.is_company">
										<div t-esc="o.partner_invoice_id.name"></div>
									</t>
									<t t-else="">
										<t t-if="o.partner_invoice_id.parent_id"><div t-esc="o.partner_invoice_id.parent_id.name"></div></t>
										<div><t t-if="o.partner_invoice_id.title"><t t-esc="o.partner_invoice_id.title.name"/>&#160;</t><t t-esc="o.partner_invoice_id.name"/><br/></div>
									</t>
									<span t-field="o.partner_invoice_id" t-options='{"widget": "contact", "fields": ["address"], "no_marker": True}'/>
								</span>


							</th>
							<th style="width: 40%;">
								<span style="width: 40%; font-family: 'DejaVu Sans'; font-size: 10.5pt; font-weight: normal;">
									<t t-if="o.partner_id.is_company">
										<div t-esc="o.partner_id.name"></div>
									</t>
									<t t-else="">
										<t t-if="o.partner_id.parent_id"><div t-esc="o.partner_id.parent_id.name"></div></t>
										<div><t t-if="o.partner_id.title"><t t-esc="o.partner_id.title.name"/>&#160;</t><t t-esc="o.partner_id.name"/><br/></div>
									</t>
									<span t-field="o.partner_id" t-options='{"widget": "contact", "fields": ["address"], "no_marker": True}'/>
								</span>
							</th>
						</tr>
					</table>
					<p t-if="o.header_comment" style="font-family: 'DejaVu Sans'; font-size: 8pt; color: black;">
						<span t-esc="o.header_comment" />
					</p>
					<h2 style="font-family: 'DejaVu Sans'; font-size: 16pt; font-weight: bold; color: black; margin-top:16px;">
						<t t-if="is_order">Order N°</t>
						<t t-else="">Quotation N°</t>
						<span t-field="o.name" />
					</h2>
					<div id="informations" class="mt-3 mb-3">
						<t t-if="is_order">
							<table class="table table-bordered table-sm text-center"
								style="margin-bottom: 2em;">
								<tr style="font-family: 'DejaVu Sans'; font-weight: bold; color: black; text-align: center;">
									<th style="width: 25%;">
										<strong class="mr16">
											<font style="font-size: 12px;">Your Reference</font>
										</strong>
									</th>
									<th style="width: 25%;">
										<strong class="mr16">
											<font style="font-size: 12px;">Date Ordered</font>
										</strong>
									</th>

									<th style="width: 25%;">
										<strong class="mr16">
											<font style="font-size: 12px;">Our Reference</font>
										</strong>
									</th>
									<th style="width: 25%;">
										<strong class="mr16">
											<font style="font-size: 12px;">Payment Term</font>
										</strong>
									</th>
								</tr>
								<tr style="font-family: 'DejaVu Sans'; font-weight: normal; color: black; text-align: center;">
									<td style="width: 25%;">
										<span style="font-size: 12px;"
											t-field="o.client_order_ref" />
									</td>


									<td style="width: 25%;">
										<span style="font-size: 12px;" t-field="o.date_order" widget="date"/>
									</td>

									<td style="width: 25%;">
										<span style="font-size: 12px;" t-field="o.user_id" />
									</td>
									<td style="width: 25%;">
										<span style="font-size: 12px;"
											t-field="o.payment_term_id" />
									</td>
								</tr>
							</table>
						</t>
						<t t-else="">
							<table class="table table-bordered table-sm text-center"
								style="margin-bottom: 2em;">
								<tr style="font-family: 'DejaVu Sans'; font-weight: bold; color: black; text-align: center;">
									<th style="width: 33.333333%;" class="align-middle small font-weight-bold">
										<strong class="mr16">
											<font style="font-size: 12px;">Your Reference</font>
										</strong>
									</th>
									<th style="width: 33.333333%;">
										<strong class="mr16">
											<font style="font-size: 12px;">Quotation Date</font>
										</strong>
									</th>
									<th style="width: 33.333333%;">
										<strong class="mr16">
											<font style="font-size: 12px;">Quotation Validity</font>
										</strong>
									</th>
								</tr>
								<tr style="font-family: 'DejaVu Sans'; font-weight: normal; color: black; text-align: center;">
									<td style="width: 33.333333%;">
										<span style="font-size: 12px;"
											t-field="o.client_order_ref" />
									</td>
									<td style="width: 33.333333%;">
										<span style="font-size: 12px;" t-field="o.date_order" />
									</td>

									<td style="width: 33.333333%;">
										<span style="font-size: 12px;" t-field="o.validity_date" />
									</td>
								</tr>
								<tr style="font-family: 'DejaVu Sans'; font-weight: bold; color: black; text-align: center;">
									<th style="width: 33.333333%;">
										<strong class="mr16">
											<font style="font-size: 12px;">Our Reference</font>
										</strong>
									</th>
									<th style="width: 33.333333%;">
										<strong class="mr16">
											<font style="font-size: 12px;">Payment Term</font>
										</strong>
									</th>
									<th style="width: 33.333333%;">
										<strong class="mr16">
											<font style="font-size: 12px;">Quotation Comment</font>
										</strong>
									</th>
								</tr>
								<tr style="font-family: 'DejaVu Sans'; font-weight: normal; font-size: 12px; color: black; text-align: center;">
									<td style="width: 33.333333%;">
										<span style="font-size: 12px;" t-field="o.user_id" />
									</td>
									<td style="width: 33.333333%;">
										<span style="font-size: 12px;"
											t-field="o.payment_term_id" />
									</td>
									<td style="width: 33.333333%;">
										<span style="font-size: 12px;"
											t-field="o.quotation_comment" />
									</td>
								</tr>
							</table>
						</t>
					</div>
					<br />

                    <t t-set="display_discount" t-value="any([l.discount or l.discount_amount for l in o.order_line])"/>


					<table class="w-100 table-sm">
						<thead class="border-bottom border-dark" style="font-family: 'DejaVu Sans'; font-weight: bold; font-size: 10pt; color: black; border-bottom: 1px solid black;">
							<tr>
								<th name="th_description" class="text-left"
									style="width:30%">
									<span>Description</span>
								</th>
								<th name="th_vat" style="width:10%"
									t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
									<span>VAT</span>
								</th>
								<th name="th_quantity" class="text-right" style="width:20%">
									<span>Quantity</span>
								</th>
								<th name="th_priceunit"
									t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}" style="width:20%">
									<span>Unit Price</span>
								</th>
								<th name="th_price_unit" t-if="display_discount"
									t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}" style="width:10%">
									<span>Disc.</span>
								</th>
								<th name="th_subtotal" class="text-right" style="width:10%">
									<!--<t groups="account.group_show_line_subtotals_tax_excluded">Amount</t> 
										<t groups="account.group_show_line_subtotals_tax_included">Total Price</t> -->
									<span>
										Price
										<span t-field="o.pricelist_id.currency_id.symbol" />
									</span>
								</th>
							</tr>
						</thead>
					</table>

					<t t-set="current_subtotal" t-value="0" />
					<t t-foreach="o.order_line" t-as="line">
						<t t-set="current_subtotal"
							t-value="current_subtotal + line.price_subtotal"
							groups="account.group_show_line_subtotals_tax_excluded" />
						<t t-set="current_subtotal"
							t-value="current_subtotal + line.price_total"
							groups="account.group_show_line_subtotals_tax_included" />

						<table class="w-100 table-sm">
							<tbody>


								<tr style="font-family: 'DejaVu Sans'; font-size: 10pt; color: black; border-bottom: 1px solid lightgray;">
									<t
										t-if="not line.display_type and line.layout_type=='article'"
										name="account_invoice_line_accountable">

										<td name="account_invoice_line_name" style="width:30%">
											<span t-field="line.name" t-options="{'widget': 'text'}" />
										</td>
										<td name="td_taxes" class="text-right" style="width:10%">
											<span
												t-esc="', '.join(map(lambda x: (x.description or x.name), line.tax_id))" />
										</td>
										<td class="text-right" style="width:20%">
											<span t-field="line.product_uom_qty" />
											<span t-field="line.product_uom_id"
												groups="uom.group_uom" />
										</td>
										<td style="width:20%"
											t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
											<span class="text-nowrap" t-field="line.price_unit" />
										</td>
										<td style="width:10%" t-if="display_discount"
											t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
											<span class="text-nowrap"
												t-esc="'{:,.2f}'.format(line._get_line_discount()) if (line._get_line_discount() != 0) else ''"/>
										</td>
										<td class="text-right o_price_total" style="width:10%">
											<span class="text-nowrap" t-field="line.price_subtotal"
												groups="account.group_show_line_subtotals_tax_excluded" />
											<span class="text-nowrap" t-field="line.price_total"
												groups="account.group_show_line_subtotals_tax_included" />
										</td>

									</t>

									<t t-if="line.display_type == 'line_section'">
										<td colspan="99">
											<span t-field="line.name" t-options="{'widget': 'text'}" />
										</td>
										<t t-set="current_section" t-value="line" />
										<t t-set="current_subtotal" t-value="0" />
									</t>
									<t t-if="line.display_type == 'line_note'">
										<td colspan="99">
											<span t-field="line.name" t-options="{'widget': 'text'}" />
										</td>
									</t>
								</tr>
								<t t-if="current_section and (line_last or o.order_line[line_index+1].display_type == 'line_section') and o.company_id.totals_below_sections">
									<tr class="is-subtotal">
										<td colspan="3">
											<strong class="mr16" style="font-family: 'DejaVu Sans'; font-size: 10pt; color: black;">
												Subtotal
												<span t-field="current_section.name"
													t-options="{'widget': 'text'}" />
											</strong>
										</td>
										<td colspan="99">
											<strong class="mr16">
												<span class="text-right" t-esc="current_subtotal"
													t-options='{"widget": "monetary", "display_currency": o.currency_id}' />
											</strong>
										</td>
									</tr>
								</t>


								<t t-if="line.layout_type=='line'">
									<tr>
										<td class="border-bottom border-dark" colspan="99">
											<font color="white">
											</font>
										</td>
									</tr>
								</t>

							</tbody>
						</table>
						<t t-if="line.layout_type=='break'">
							<tr>
								<td>
									<p style="page-break-after:always;" />
									<br />
									<table class="w-100 table-sm">
										<thead class="border-bottom border-dark" style="font-family: 'DejaVu Sans'; font-size: 10pt; font-weight: bold; color: black;">
											<tr>
												<th name="th_description" class="text-left"
													style="width:30%">
													<span>Description</span>
												</th>
												<th name="th_vat" style="width:10%"
													t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
													<span>VAT</span>
												</th>
												<th name="th_quantity" class="text-right" style="width:20%">
													<span>Quantity</span>
												</th>
												<th name="th_priceunit"
													t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}" style="width:20%">
													<span>Unit Price</span>
												</th>
												<th name="th_price_unit" t-if="display_discount"
													t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}" style="width:10%">
													<span>Disc.</span>
												</th>
												<th name="th_subtotal" class="text-right" style="width:10%">
													<!--<t groups="account.group_show_line_subtotals_tax_excluded">Amount</t> 
														<t groups="account.group_show_line_subtotals_tax_included">Total Price</t> -->
													<span>
														Price
														<span t-field="o.pricelist_id.currency_id.symbol" />
													</span>
												</th>
											</tr>
										</thead>
									</table>
								</td>
							</tr>
						</t>
					</t>

					<div class="clearfix">
						<div id="total" class="row">
							<div t-attf-class="col-4 ml-auto">
								<table class="table table-sm"
									style="page-break-inside: avoid; font-family: 'DejaVu Sans'; font-size: 10pt; color: black; margin-right: 0px; margin-left: auto;">

									<!-- Amount without taxes -->
									<tr t-if="o.print_totals" class="border-black o_subtotal">
										<td>Total w/out VAT</td>
										<td class="text-right">
											<span t-field="o.amount_untaxed" />
										</td>
									</tr>
									<tr t-if="o.print_vat">
										<td>Taxes</td>
										<td class="text-right">
											<span t-field="o.amount_tax" />
										</td>
									</tr>
									<tr t-if="o.print_vat" class="border-black o_total">
										<td>
											<strong style="color: black; font-weight: bold;">Total with VAT</strong>
										</td>
										<td class="text-right">
											<span class="text-nowrap" style="color: black; font-weight: bold;" t-field="o.amount_total" />
										</td>
									</tr>
								</table>
							</div>
						</div>
					</div>
					<p t-if="o.note" style="font-family: 'DejaVu Sans'; font-size: 9pt; color: black;">
						<span t-esc="o.note" />
					</p>
					<p t-if="o.footer_comment" style="font-family: 'DejaVu Sans'; font-size: 8pt; color: black;">
						<span t-esc="o.footer_comment" />
					</p>
					<p t-if="o.fiscal_position_id.note" name="note" class="mt-5">
						<span t-field="o.fiscal_position_id.note" />
					</p>
					<div class="oe_structure" />
				</div>
			</t>
		</template>

		<!-- Create the base report -->
		<template id="report_so_base">
			<t t-call="web.html_container">
				<t t-foreach="docs" t-as="doc">
					<t t-set="lang" t-value="doc.partner_id.lang" />
					<t t-call="prisme_outputs_sale.report_so_view" t-lang="lang" />
				</t>
			</t>
		</template>

		<report id="prisme_report_so" model="sale.order"
			string="Prisme Quotation/SO"
			name="prisme_outputs_sale.report_so_base"
			file="prisme_outputs_sale.report_so_base" report_type="qweb-pdf" />
	</data>
</odoo>